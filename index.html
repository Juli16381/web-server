<!DOCTYPE html> 
<html lang="es"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Datos GPS</title> 
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" /> 
    <style> 
        body { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin: 0; 
            font-family: Arial, sans-serif; 
            background-color: #f0f0f0; 
        } 
        .container { 
            display: flex; 
            flex-direction: row; 
            justify-content: center; 
            align-items: flex-start; 
            margin-top: 20px; 
            width: 90%; 
        } 
        #map { 
            height: 500px; 
            width: 60%; 
            border: 2px solid #ce72c0; 
            margin-right: 20px; 
            position: relative; 
        } 
        table { 
            border-collapse: collapse; 
            width: 100%; 
            text-align: center; 
            background-color: #ffffff; 
        } 
        th, td { 
            border: 1px solid #000; 
            padding: 8px; 
        } 
        th { 
            background-color: #ce72c0; 
            color: white; 
        } 
        #historicos { 
            margin-top: 20px; 
            text-align: center; 
        } 
        #historicos-btn { 
            padding: 10px 20px; 
            background-color: #ce72c0; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            margin-bottom: 10px; 
        } 
        #historicos-table { 
            margin-top: 20px; 
        } 
        .data-container { 
            width: 35%; 
        } 
        .title { 
            font-size: 24px; 
            color: #333; 
            margin-bottom: 10px; 
        } 
        .leaflet-control { 
            background-color: white; 
            padding: 10px; 
            border-radius: 5px; 
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); 
        } 
        .filter-container { 
            margin-top: 20px; 
            text-align: center; 
        }

        .filter-container label {
            margin-right: 10px;
        }

        .filter-container input {
            margin-right: 10px;
        }

        .filter-container button {
            padding: 10px 20px;
            background-color: #ce72c0;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        /* Media query para pantallas móviles */ 
        @media (max-width: 768px) { 
            .container { 
                flex-direction: column; 
                align-items: center; 
            } 
            #map { 
                width: 90%; 
                margin-right: 0; 
                margin-bottom: 20px; 
            } 
            .data-container { 
                width: 90%; 
            } 
        } 
    </style> 
</head> 
<body> 
    <h1 class="title">Datos GPS</h1> 

    <!-- Formulario de filtro por fecha y hora -->
    <div class="filter-container">
        <label for="start-date">Fecha y hora de inicio:</label>
        <input type="datetime-local" id="start-date" name="start-date">
        
        <label for="end-date">Fecha y hora de fin:</label>
        <input type="datetime-local" id="end-date" name="end-date">
        
        <button id="filter-btn">Filtrar</button>
        <button id="clear-filter-btn">Quitar Filtro</button>
    </div>

    <div class="container"> 
        <!-- Contenedor para el Mapa --> 
        <div id="map"></div> 
        <!-- Contenedor de Datos --> 
        <div class="data-container"> 
            <div id="historicos"> 
                <button id="historicos-btn">Ver historial</button> 
                <table id="historicos-table" style="display: none;"> 
                    <thead> 
                        <tr> 
                            <th>Latitud</th> 
                            <th>Longitud</th> 
                            <th>Fecha</th> 
                            <th>Hora</th> 
                        </tr> 
                    </thead> 
                    <tbody id="historicos-data"> 
                        <!-- Aquí se insertarán los datos históricos dinámicamente --> 
                    </tbody> 
                </table> 
            </div> 
        </div> 
    </div> 

    <script src="/socket.io/socket.io.js"></script> 
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script> 
    <script> 
    document.addEventListener('DOMContentLoaded', function() { 
        const socket = io(); 
        let autoCenter = true; 
        let autoCenterTimeout; 
        let recorrido = L.polyline([], { color: '#800080' }).addTo(map);
        let filtrando = false; // Controla si se está aplicando un filtro de fechas

        const filterBtn = document.getElementById('filter-btn');
        const clearFilterBtn = document.getElementById('clear-filter-btn');
        
        // Inicializar el mapa de Leaflet 
        const map = L.map('map').setView([0, 0], 2); 
        map.on('movestart', function() { 
            autoCenter = false; 
            clearTimeout(autoCenterTimeout); 
            autoCenterTimeout = setTimeout(function() { 
                autoCenter = true; 
            }, 10000); 
        }); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            maxZoom: 18, 
            attribution: '© OpenStreetMap contributors' 
        }).addTo(map); 

        let ultimaUbicacionControl = L.control({position: 'bottomleft'}); 
        ultimaUbicacionControl.onAdd = function(map) { 
            const div = L.DomUtil.create('div', 'leaflet-control'); 
            div.id = 'ultima-ubicacion-info'; 
            div.innerHTML = ` 
                <b>Última ubicación</b><br> 
                Latitud: <span id="ultima-latitud">-</span><br> 
                Longitud: <span id="ultima-longitud">-</span><br> 
                Fecha: <span id="ultima-fecha">-</span><br> 
                Hora: <span id="ultima-hora">-</span> 
            `; 
            return div; 
        }; 
        ultimaUbicacionControl.addTo(map); 

        let marcadorUltimaUbicacion = L.circleMarker([0, 0], { 
            radius: 10, 
            color: '#800080', 
            fillColor: '#800080', 
            fillOpacity: 1, 
        }).addTo(map); 

        // Manejar el botón de Filtrar
        filterBtn.addEventListener('click', () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!startDate || !endDate) {
                alert('Por favor, selecciona ambas fechas para aplicar el filtro.');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('La fecha de inicio no puede ser mayor que la fecha de fin.');
                return;
            }

            filtrando = true; // Activar el estado de filtrado

            // Llamar al servidor para filtrar los datos
            fetch(`/filterData?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}`)
                .then(response => response.json())
                .then(data => {
                    // Limpiar el mapa y la tabla de datos históricos
                    recorrido.setLatLngs([]);
                    document.getElementById('historicos-data').innerHTML = '';

                    // Procesar los datos filtrados y mostrarlos en el mapa y la tabla
                    data.forEach(record => {
                        const nuevaLatitud = parseFloat(record.Latitud);
                        const nuevaLongitud = parseFloat(record.Longitud);
                        const fechaFormateada = record.Fecha.split('T')[0];
                        
                        recorrido.addLatLng([nuevaLatitud, nuevaLongitud]);
                        
                        const historicosTable = document.getElementById('historicos-data');
                        const historicosRow = document.createElement('tr');
                        historicosRow.innerHTML = `
                            <td>${record.Latitud}</td>
                            <td>${record.Longitud}</td>
                            <td>${fechaFormateada}</td>
                            <td>${record.Hora}</td>
                        `;
                        historicosTable.insertBefore(historicosRow, historicosTable.firstChild);
                    });
                })
                .catch(error => console.error('Error al filtrar los datos:', error));
        });

        // Manejar el botón de Quitar Filtro
        clearFilterBtn.addEventListener('click', () => {
            filtrando = false; // Desactivar el estado de filtrado
            cargarDatosDesdeServidor(); // Volver a cargar todos los datos desde el servidor
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
        });

        // Escuchar los datos nuevos que llegan a través de Socket.io
        socket.on('new-data', (data) => {
            if (!filtrando) {
                actualizarMapa(data); // Solo actualizar el mapa si no estamos filtrando
            }
        });

        function actualizarMapa(data) {
            const nuevaLatitud = parseFloat(data.Latitud); 
            const nuevaLongitud = parseFloat(data.Longitud); 
            const fechaFormateada = data.Fecha.split('T')[0]; 
            document.getElementById('ultima-latitud').innerText = data.Latitud; 
            document.getElementById('ultima-longitud').innerText = data.Longitud; 
            document.getElementById('ultima-fecha').innerText = fechaFormateada; 
            document.getElementById('ultima-hora').innerText = data.Hora;

            if (autoCenter) { 
                map.setView([nuevaLatitud, nuevaLongitud], 15); 
            } 
            recorrido.addLatLng([nuevaLatitud, nuevaLongitud]); 
            marcadorUltimaUbicacion.setLatLng([nuevaLatitud, nuevaLongitud]); 

            const historicosTable = document.getElementById('historicos-data'); 
            const historicosRow = document.createElement('tr'); 
            historicosRow.innerHTML = ` 
                <td>${data.Latitud}</td> 
                <td>${data.Longitud}</td> 
                <td>${fechaFormateada}</td> 
                <td>${data.Hora}</td> 
            `; 
            historicosTable.insertBefore(historicosRow, historicosTable.firstChild); 
        }

        function cargarDatosDesdeServidor() { 
            fetch('/historicos') 
            .then(response => response.json()) 
            .then(data => { 
                if (data.length > 0) { 
                    let ultimaLatitud = null; 
                    let ultimaLongitud = null; 
                    data.reverse().forEach((registro) => { 
                        const nuevaLatitud = parseFloat(registro.Latitud); 
                        const nuevaLongitud = parseFloat(registro.Longitud); 
                        const fechaFormateada = registro.Fecha.split('T')[0]; 
                        recorrido.addLatLng([nuevaLatitud, nuevaLongitud]); 
                        ultimaLatitud = nuevaLatitud; 
                        ultimaLongitud = nuevaLongitud; 
                        const historicosTable = document.getElementById('historicos-data'); 
                        const historicosRow = document.createElement('tr'); 
                        historicosRow.innerHTML = ` 
                            <td>${registro.Latitud}</td> 
                            <td>${registro.Longitud}</td> 
                            <td>${fechaFormateada}</td> 
                            <td>${registro.Hora}</td> 
                        `; 
                        historicosTable.insertBefore(historicosRow, historicosTable.firstChild); 
                    }); 
                    if (ultimaLatitud !== null && ultimaLongitud !== null) { 
                        map.setView([ultimaLatitud, ultimaLongitud], 15); 
                        marcadorUltimaUbicacion.setLatLng([ultimaLatitud, ultimaLongitud]); 
                    } 
                } 
            }) 
            .catch(error => console.error('Error al cargar los datos históricos:', error)); 
        }
    }); 
    </script> 
</body> 
</html>

